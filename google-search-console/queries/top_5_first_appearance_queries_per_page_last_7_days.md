# Top 5 Most Clicked "First Appearance" Queries Per Page In The Last 7 Days (Top 100 Pages)

Instructions | Details
---|---
Description | <ul><li>Display the top 100 pages with the most clicks generated by "first appearance" queries in the last seven days. For each page, also display the five "first appearance" queries that generated the clicks.</li><li>We define a <b>"first appearance" query</b> as a query that has position ≤ 30 this week and has never had position ≤ 30 before. It may or may not have clicks, but will at least have one impression.</li><li>"First appearance" queries have an upward trajectory. So, by optimizing your pages for these keywords, it is possible to increase your search traffic.</li><li>Note: since not every page on your site will have five "first appearance" queries each week, this query will not always return 100 pages accompanied by five queries. Nor will each page always have five queries, they may have less than that.</li></ul>
Requirements | Collect the Panoply Google Search Console data source with the default set of metrics and dimensions. Dimensions used: `date`, `page`, and `query`. Metrics used: `clicks` and `position`.
Usage | Create a table to see which new keywords pages are ranking for each week. Create a bar or line chart to show how many more keywords each page ranks for over time.
Modifications | <ul><li><b>Custom number of queries: </b>In the final `FROM` statement, change `WHERE rank <= 5` to `WHERE rank <= N` to get the top N most clicked "first appearance" queries per page, for some whole number N.</li> <li><b>Custom date range: </b>Change all instances of `'7 days'` to `'N days'` to get the top 5 most clicked "first appearance" queries in the last N days, for some whole number N.</li></ul>

```sql
WITH first_appearance_queries AS(
    SELECT
        page,
        query,
        SUM(clicks) AS total_clicks,
        ROW_NUMBER() OVER(PARTITION BY page ORDER BY total_clicks DESC) AS rank
    FROM google_search_console_blog
    WHERE date >= current_date - interval '7 days'
		AND position <= 30
        AND query IN (SELECT query
							  FROM google_search_console_blog
                     	      WHERE date < current_date - interval '7 days'
                          			AND position > 30)
    GROUP BY 1, 2
    ORDER BY page, total_clicks DESC)
SELECT DISTINCT
	page,
	LISTAGG(query, ', ') OVER(PARTITION BY page) AS top_5_queries,
	SUM(total_clicks) OVER(PARTITION BY page) AS total_clicks
FROM (SELECT * 
	  FROM first_appearance_queries
	  WHERE rank <= 5)
ORDER BY total_clicks DESC
LIMIT 100;
```

## Query Results Dictionary
Column | Description
---|---
`page`| The page on your site appearing in search results.
`top_5_queries`| The five 'first appearance' queries that have generated the most clicks for this page in the last seven days.
`total_clicks`| The sum of all the clicks that the five queries generated for this page in the last seven days.